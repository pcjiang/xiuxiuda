<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta charset="utf-8" />
		<title>å°æ˜å­˜åŒ…</title>
		<script src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
		<!--<script type="text/javascript" src="../public/xiaoming/js/global_fun.js"></script>-->
	</head>
	<body>
		<div onclick="sao();">æ‰«ä¸€æ‰«ğŸ é£é£é±¼</div>
		<div onclick="sao();">æ‰«ä¸€æ‰«ğŸ é£é£é±¼</div>
		<input name="MEI" placeholder="MEI" value="a3abce2a43ca6339">
		<input name="lock_plate_dial" placeholder="é”æ¿æ‹¨ç å·" value="1">
		<input name="lock_play_channel_num" placeholder="é€šé“å·" value="1">
		<input name="take_code" placeholder="å–ä»¶ç " value="5678">
		<input name="order_id" placeholder="è®¢å•id" value="2">
		<input name="number" placeholder="æŸœå·" value="2">
		<input name="clear_cabinet" placeholder="æ˜¯å¦æ¸…é™¤æŸœé—¨ä¿¡æ¯" value="0">
		<input name="o_t" placeholder="å¼€æŸœç±»å‹" value="1">
		<button id="send" onclick="send()">å‘é€å¼€æŸœæŒ‡ä»¤</button>
		<button id="send" onclick="pay()">æ”¯ä»˜</button>
	</body>
	
	<script>
		$.ajax({
			url:'/api/wechat/getWxJsConfig',
			type:'get',
			data:{
				url:'/xiuxiuda/ceshi.html'	//å¿…é¡»æ˜¯å½“å‰url
			},
			success:function(e){
				if(e.state != 1){
					alert(e.msg);return false;
				}
				
				var data = {
					    debug: true, // å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰apiçš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯alertå‡ºæ¥ï¼Œè‹¥è¦æŸ¥çœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨pcç«¯æ‰“å¼€ï¼Œå‚æ•°ä¿¡æ¯ä¼šé€šè¿‡logæ‰“å‡ºï¼Œä»…åœ¨pcç«¯æ—¶æ‰ä¼šæ‰“å°ã€‚
					    appId: e.config.appId, // å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
					    timestamp: e.config.timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
					    nonceStr: e.config.nonceStr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
					    signature: e.config.signature,// å¿…å¡«ï¼Œç­¾å
					    jsApiList : [ 'checkJsApi', 'startRecord', 'stopRecord','translateVoice','scanQRCode', 'openCard' ], // å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨
					}
				console.log(333333333,data);
				wx.config(data);
				
			},
			error:function(){
				alert('ç½‘ç»œé”™è¯¯');
			}
			
		});
		
		var code = getUrlParam('code');
		/* $.ajax({
			url:'/api/save/index',
			type:'get',
			data:{
				code:code,
				callback_url:'/xiaoming/ceshi.html'
			},
			success:function(e){
				if(e.state == 2){
					location.href=e.redirect_url;
				}
				alert(e.msg);
				console.log(111111111,e);
			},
			error:function(){
				alert('ç½‘ç»œé”™è¯¯');
			}
			
		}); */
		
		/**
		 * è·å–urlé‡Œé¢çš„å‚æ•°(name)
		 *
		 **/
	   function getUrlParam(name) {
	       var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //æ„é€ ä¸€ä¸ªå«æœ‰ç›®æ ‡å‚æ•°çš„æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
	       var r = window.location.search.substr(1).match(reg);  //åŒ¹é…ç›®æ ‡å‚æ•°
	
	       if (r != null)
	           return unescape(r[2]);
	       return null; //è¿”å›å‚æ•°å€¼
	   }
		
		function sao(){
			wx.scanQRCode({
				needResult: 0, // é»˜è®¤ä¸º0ï¼Œæ‰«æç»“æœç”±å¾®ä¿¡å¤„ç†ï¼Œ1åˆ™ç›´æ¥è¿”å›æ‰«æç»“æœï¼Œ
				scanType: ["qrCode","barCode"], // å¯ä»¥æŒ‡å®šæ‰«äºŒç»´ç è¿˜æ˜¯ä¸€ç»´ç ï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
				success: function (res) {
					var result = res.resultStr; // å½“needResult ä¸º 1 æ—¶ï¼Œæ‰«ç è¿”å›çš„ç»“æœ
				}
			});
		}
		
		function send(){
			var param = {
					MEI:$('input[name=MEI]').val(),
					lock_plate_dial:$('input[name=lock_plate_dial]').val(),
					lock_play_channel_num:$('input[name=lock_play_channel_num]').val(),
					take_code:$('input[name=take_code]').val(),
					order_id:$('input[name=order_id]').val(),
					number:$('input[name=number]').val(),
					o_t:$('input[name=o_t]').val(),
					clear_cabinet:$('input[name=clear_cabinet]').val(),
			};
			
			$.ajax({
				url:'/api/save/openTest',
				type:'get',
				data:param,
				success:function(e){
					if(e.state == 2){
						location.href=e.redirect_url;
					}
					alert(e.msg);
					alert(e.res.error);
					console.log(111111111,e);
				},
				error:function(){
					alert('ç½‘ç»œé”™è¯¯');
				}
				
			});
		}
		
		function pay(){
			$.ajax({
                type:"post",
                async:true,
                url:"/api/Goods_buy/getWxPay",// è½®è¯¢è·å–è®¢å•æ”¯ä»˜çŠ¶æ€
                data:{
                    order_id:1073,
                    callback_url:window.location.href,
                    code:code
                },
                success:function(res){
                	console.log(res);
                	//å®šä¹‰å¾®ä¿¡æ”¯ä»˜æ¥å£
        			wx.chooseWXPay({
        				timestamp: res.result.timeStamp, // æ”¯ä»˜ç­¾åæ—¶é—´æˆ³ï¼Œæ³¨æ„å¾®ä¿¡jssdkä¸­çš„æ‰€æœ‰ä½¿ç”¨timestampå­—æ®µå‡ä¸ºå°å†™ã€‚ä½†æœ€æ–°ç‰ˆçš„æ”¯ä»˜åå°ç”Ÿæˆç­¾åä½¿ç”¨çš„timeStampå­—æ®µåéœ€å¤§å†™å…¶ä¸­çš„Så­—ç¬¦
        				nonceStr: res.result.nonceStr, // æ”¯ä»˜ç­¾åéšæœºä¸²ï¼Œä¸é•¿äº 32 ä½
        				package: res.result.package, // ç»Ÿä¸€æ”¯ä»˜æ¥å£è¿”å›çš„prepay_idå‚æ•°å€¼ï¼Œæäº¤æ ¼å¼å¦‚ï¼šprepay_id=***ï¼‰
        				signType: res.result.signType, // ç­¾åæ–¹å¼ï¼Œé»˜è®¤ä¸º'SHA1'ï¼Œä½¿ç”¨æ–°ç‰ˆæ”¯ä»˜éœ€ä¼ å…¥'MD5'
        				paySign: res.result.paySign, // æ”¯ä»˜ç­¾å
        				success: function(res) {
        					pSucc(res);
        				},
        				cancel: function(res) {
        					pCancel(res);
        				},
        				fail: function(res) {
        					pFail(res);
        				}
        			});
                       
				}
            })
			
			
			
			
			
		}
	</script>
	
</html>
